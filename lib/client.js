// Generated by CoffeeScript 1.7.1
(function() {
  var CONNECTION_LINGER, CONNECTION_TIMEOUT, Client, Connection, ConsulAgent, KEEPALIVE, VERBOSE, helpers, log, util, _,
    __slice = [].slice;

  util = require('util');

  helpers = require('./helpers');

  _ = require('underscore');

  ConsulAgent = require('./consul-agent');

  Connection = require('./connection');

  log = helpers.log;

  VERBOSE = false;

  KEEPALIVE = true;

  CONNECTION_TIMEOUT = 6500;

  CONNECTION_LINGER = 1500;

  Client = function(options) {
    this.options = options != null ? options : {};
    this.consul_agent = new ConsulAgent;
    return this;
  };

  Client.prototype.service_connections = {};

  Client.prototype.remote = function() {
    var args, cb, method, service_name, _i;
    service_name = arguments[0], method = arguments[1], args = 4 <= arguments.length ? __slice.call(arguments, 2, _i = arguments.length - 1) : (_i = 2, []), cb = arguments[_i++];
    return this.getServiceConnection(service_name, function(err, service_connection) {
      if (err) {
        return log.e(err);
      } else {
        return service_connection.sendMethod.apply(service_connection, [method].concat(__slice.call(args), [cb]));
      }
    });
  };

  Client.prototype.on = function(service_name, type, cb) {
    return this.getServiceConnection(service_name, function(err, service_connection) {
      if (err) {
        return log.e(err);
      } else {
        return service_connection.sendSubscribe(type, cb);
      }
    });
  };

  Client.prototype.getServiceConnection = function(service_name, cb) {
    var service_connection;
    if (service_connection = this.service_connections[service_name]) {
      return cb(null, service_connection);
    } else {
      return this.getServiceHealth(service_name, (function(_this) {
        return function(err, instances) {
          var healthy_instances, instance;
          healthy_instances = instances.filter(function(i) {
            return i.Checks.filter(function(c) {
              return c.Status === 'critical';
            }).length === 0;
          });
          if (!healthy_instances.length) {
            return cb("Could not find service", null);
          }
          instance = helpers.randomChoice(healthy_instances);
          service_connection = _this.connectToService(instance);
          _this.saveServiceConnection(service_name, service_connection);
          return cb(null, service_connection);
        };
      })(this));
    }
  };

  Client.prototype.getServiceHealth = function(service_name, cb) {
    return this.consul_agent.getServiceHealth(service_name, cb);
  };

  Client.prototype.connectToService = function(instance) {
    var connection;
    if (VERBOSE) {
      log.s("[connectToService] Connecting to " + (util.inspect(instance)));
    }
    connection = Connection.fromConsulService(instance);
    return connection;
  };

  Client.prototype.saveServiceConnection = function(service_name, service_connection) {
    this.service_connections[service_name] = service_connection;
    if (!KEEPALIVE) {
      return setTimeout(this.killConnection.bind(this, service_name, service_connection), CONNECTION_TIMEOUT);
    }
  };

  Client.prototype.killConnection = function(service_name, service_connection) {
    setTimeout((function() {
      return service_connection.close();
    }), CONNECTION_LINGER);
    return delete this.service_connections[service_name];
  };

  module.exports = Client;

}).call(this);
